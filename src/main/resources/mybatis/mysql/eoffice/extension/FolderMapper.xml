<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.xbeeant.eoffice.mapper.FolderMapper">
    <select id="hasPermissionFolders" resultMap="BaseResultMap">
        select fid, pfid, name, icon, path, display_order
        from eoffice_folder
        where deleted = 0
          and fid in (select target_id from eoffice_perm where type = 1 and uid = #{userId,jdbcType=VARCHAR})
    </select>

    <select id="subFolders" resultMap="BaseResultMap">
        select *
        from (
                     select t1.*,
                            if(find_in_set(pfid, @pids) > 0, @pids := concat(@pids, ',', fid), 0) as ischild
                     from (
                                  select fid, pfid, name
                                  from eoffice_folder t
                                  where deleted = 0
                                  order by pfid, fid
                                  ) t1,
                          (select @pids := #{fid,jdbcType=BIGINT}) t2
                     ) t3
        where ischild != 0;
    </select>

    <select id="parents" resultMap="BaseResultMap">
        SELECT t3.*
        FROM (SELECT t1.*,
                     IF(FIND_IN_SET(fid, @ids) > 0, @ids := CONCAT(pfid, ',', @ids), '0') AS isparent
              FROM (SELECT t.fid, t.pfid, t.NAME
                    FROM eoffice_folder AS t
                    ORDER BY t.fid DESC) t1,
                   (SELECT @ids := #{fid,jdbcType=BIGINT}) t2) t3
        WHERE t3.isparent != '0'
    </select>
</mapper>